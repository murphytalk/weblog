Title: ChatOps with Hubot - Anki automation
Category: computer
Tags: chatops,anki,bot,coffeescript
Date: 2016-06-22 23:40
Well, the very topic of [ChatOps](https://www.google.co.jp/?ion=1&espv=2#q=chatops) has already been discussed at length by many people, so I am gonna jump to my very first ChatOps with Hubot  right away.

First : the motivation.

I discovered [Anki](https://en.wikipedia.org/wiki/Anki_(software)) quite a while ago, it has been helping me to expand and improve my English vocabulary - and my kid's Chinese vocabulary as well. It comes with a mobile app (only the [Android version](https://play.google.com/store/apps/details?id=com.ichi2.anki&hl=en) is free, but I am sure Apple fanboys won't mind to pay extra for their beloved iPhone) which is handy, but still whenever I wanted to add a new word that I bumped into during my reading, it does not feel that convenient: You know what I mean if you have ever tried to manually add a new word to Anki.

Enter [anki-sync-server](https://github.com/dsnopek/anki-sync-server).

In short, it is a private Anki sync server, and most beautifully, it comes with a super cool (but badly documented) [RESTful API](https://github.com/dsnopek/anki-sync-server/wiki/RESTful-API-Documentation) which makes automation possible. And being a lazy engineer, I love to automate things.

Well, to be fair, the document is not that bad if you read [the code](https://github.com/dsnopek/anki-sync-server/blob/master/AnkiServer/apps/rest_app.py) very carefully. Here's what I've figured out.

1. Collection - the name is kind of miss leading in my opinion. Actually, the collection name is just your user name.
2. All requests must be sent as POST.
3. Anki manages words by using notes: a note is where you put your new word and its explanation etc. You only add note but not card, the latter  is generated by Anki automatically to reflect on side of the note (remember you can have reversed card).

Use `wget` to try some quick examples.

List all decks:

```bash
wget --post-data='{}'  --header "Accept: application/json" http://127.0.0.1:27701/collection/username/list_deck
```

List all models (card types):

```bash
wget --post-data='{}'  --header "Accept: application/json" http://127.0.0.1:27701/collection/username/list_models
```

Finally, my goal : add a new word as note

```bash
wget --post-data='{"model":"English","fields":{"Word":"exasperate","Meaning":"irritate intensely; infuriate","Phonetic":"/ɪɡˈzasp(ə)reɪt,ɛɡ-/","Reverse":"y"}}'  --header "Accept: application/json" http://127.0.0.1:27701/collection/username/add_note
```

Next: the goal.

With the logistics being sorted out, here's the deal : next time when a new word finds me, I will paste it to my slack channle where my bot is wating for commands, and I want my bot to figure out the new word's meaning, pronounciation, along with examples, and add them to my private Anki server automatically. All I need to do later is to sync my Anki app with the server.

Obviously my bot would need a dictionary, and lucky for him the [Longman dictionary API](http://developer.pearson.com/apis/dictionaries) is free for up to 4,000,000 calls per month (Thank you! Pearson Inc !!).

Again, a quick `wget` dry run:

```bash
wget --header "Accept: application/json" http://api.pearson.com/v2/dictionaries/ldoce5/entries?headword=exasperate

```

`ldoce5` is the ID of Longman Dictionary of Contemporary English. Note `GET` is used. Multiple results will be returned as a JSON object. There are some details to be taken care of, please refer to [this little CoffeeScript](https://github.com/murphytalk/mubot/blob/master/scripts/anki.coffee). By the way, [CoffeeScript](https://en.wikipedia.org/wiki/CoffeeScript) was chosen by the author of Hubot not me, and that's the virgin piece of CoffeeScript of mine, I have every right to be lousy and clumsy :)

What's left is to connect my bot with Slack and join my team (it's called _Under Lu's Roof_, obviously it's meant for family business). This is no-brainer as people in the Hubot community have contributed all sorts of adapters inlcuding [Hubot Slack](https://github.com/slackhq/hubot-slack). It has some limits : the bot cannot recieve direct message ; and it has to be invited into a channel first, etc. but managable.

Finally, let's put it action:

![Bot in Slack]({filename}/images/hubot-anki.png)

Added ! Then I sync in the Anki app:

![Anki App]({filename}/images/anki.png)

Isn't that neat !?

Oh, did I mention that Anki is also being used to help my kid with his Chinese vocabulary? I couldn't find a good online source to look for Chinese character's pronounciation (namely Pinyin), so I wrote a small Python script to do the trick: it outputs pinyin with tune, and the traditional Chinese form if there is any. Will teach my bot this trick for sure !
